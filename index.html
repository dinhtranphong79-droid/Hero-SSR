<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Điểm tướng SSR & Exp</title>
<style>
:root{
  --bg:#ffffff;
  --card:#f0f0f0;
  --muted:#555555;
  --accent:#60a5fa;
}
body {margin:0;padding:18px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#012;}
.app {max-width:1100px;margin:0 auto;}
header {display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;}
h1 {font-size:20px;margin:0;}
.controls {display:flex;gap:8px;align-items:center;}
.tabs {display:flex;gap:6px;flex-wrap:wrap;}
.tab {padding:8px 12px;border-radius:10px;cursor:pointer;background:#e6e6e6;color:var(--muted);}
.tab.active {background:var(--accent);color:#fff;font-weight:600;}
.grid {display:grid;grid-template-columns:1fr 360px;gap:16px;}
.panel {background:#f8f8f8;padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.1);}
.hero-list {display:flex;flex-direction:column;gap:10px;max-height:480px;overflow:auto;}
.hero {display:grid;grid-template-columns:1fr 110px 90px 110px 80px;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fff;}
.hero small {color:var(--muted);}
input[type="number"], select {width:100%;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:inherit;}
.btn {padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600;}
.btn.ghost {background:transparent;border:1px solid rgba(0,0,0,0.1);color:var(--muted);}
.summary {display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.row {display:flex;justify-content:space-between;align-items:center;}
.big {font-size:18px;font-weight:700;}
footer {margin-top:16px;color:var(--muted);font-size:13px;text-align:center;}
.hero-ops {display:flex;gap:6px;}
@media (max-width:980px){.grid{grid-template-columns:1fr;}.hero{grid-template-columns:1fr 90px 80px 80px 70px;}}
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>Điểm tướng SSR & Exp</h1>
  </div>
  <div class="controls">
    <div class="tabs" id="tabs"></div>
  </div>
</header>
<main class="grid">
<section class="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div><strong id="systemTitle">Lửa</strong></div>
    <div class="flex">
      <button class="btn" id="btnCalcAll">Tính toàn bộ</button>
    </div>
  </div>
  <div style="margin-bottom:12px"><input id="filterHero" placeholder="Tìm tướng theo tên" /></div>
  <div class="hero-list" id="heroList"></div>
</section>
<aside class="panel">
  <div><strong>Tổng kết</strong></div>
  <div class="summary" id="summary"></div>
</aside>
</main>
<footer>SSR & Exp, bậc 0★, tính thẻ còn thiếu để 5★. Tự lưu tự động.</footer>
</div>
<script>
const COST={
0:{1:1},
1:{1:20,2:20},
2:{1:30,2:40,3:50},
3:{1:60,2:70,3:80,4:80},
4:{1:100,2:110,3:120,4:130,5:140},
5:{1:170,2:180,3:190,4:200,5:210}
};
const SYSTEMS=["Lửa","Cung","Độc","Băng"];
const EXP_CATS=["B+","B","SR"];
const $=id=>document.getElementById(id);

let state={heroes:[],activeTab:SYSTEMS[0]};

const heroesData = {
  Lửa:["Dolvar","Paul","Alex","Allen","Anko","Apollo","Blaise","Brie","Catrina","Christie","Cosette","Dain","Darcy","Daria","Dean","Edmund"],
  Cung:["Aidan","Alden","Ariza","Authur","Bella","Colin","Doris","Dylan","Eleanora","Fatima","Gabriel","Green","Jennifer","Johannes","Kadir","Kailin","Layla","Livia","Maya","Meg","Mira","Montag","O'Neil","Padme","Pan","Ptolemy","Richard","Ryan","Sahar","Sebastian","Seraphia","Solder","Torvi","Trist"],
  Độc:["Allison","Angelina","Arwin","Benjamin","Blackwell","Boudica","Catherine","Chiyoko","Claudia","Daisy","Elia","Gruen","Issac","Lilith","Lomax","Luvia","Maxwell","Meniere","Morgana","Mycelia","Naga","Pythia","Rila","Rogers","Rosamond","Suad","Tumnus","Viper","Viola","Webster","Wendy"],
  Băng:["Christine","Clarence","Enzo","Eslaine","Filius","Hadi","Hana","Hathes","Havik","Jessica","Judy","Keith","Lilani","Loka","Maud","Nathaniel","Nicole","Nina","Nivea","Olaf","Parr","Paula","Pedra","Ralph","Rebecca","Rudolph","Selene","Trishy","Vera","Ao Deng","Ao Yue"]
};
const expData={"B+":["Daniel"],"B":["Anton","Peter","Etley"],"SR":["Alucard","Samar","Harold","Kris","Merlin","Ophelia","Arwyn"]};

function defaultHeroData(name, system){return {id:"i-"+Math.random().toString(36).substr(2,9),name,system,current_star:0,current_bar:0,cards_owned:0};}
function maxBarForStar(st){return COST[st]?Math.max(...Object.keys(COST[st])):0;}
function formatNumber(n){return Number(n).toLocaleString("vi-VN");}

function saveState(){localStorage.setItem("heroesState", JSON.stringify(state.heroes));}
function loadState(){
  const data = localStorage.getItem("heroesState");
  if(data) state.heroes = JSON.parse(data);
}

function createHeroElement(h){
  const box=document.createElement("div"); box.className="hero";
  const nameCol=document.createElement("div");
  nameCol.innerHTML=`<div style="font-weight:600">${h.name}</div><small>${h.system}</small>`;
  const starCol=document.createElement("div");
  const starSel=document.createElement("select");
  starSel.innerHTML=Array.from({length:6}).map((_,i)=>`<option value="${i}" ${i===h.current_star?"selected":""}>${i}★</option>`).join("");
  starSel.onchange=()=>{
    h.current_star=parseInt(starSel.value,10);
    if(h.current_bar>maxBarForStar(h.current_star)) h.current_bar=maxBarForStar(h.current_star);
    saveState();
    renderHeroList(); renderSummary();
  }
  starCol.appendChild(starSel);

  const barCol=document.createElement("div");
  const barSel=document.createElement("select");
  const maxBar=maxBarForStar(h.current_star);
  barSel.innerHTML=Array.from({length:maxBar+1}).map((_,i)=>`<option value="${i}" ${i===h.current_bar?"selected":""}>Bậc ${i}</option>`).join("");
  barSel.onchange=()=>{
    h.current_bar=parseInt(barSel.value,10);
    saveState();
    renderSummary();
  }
  barCol.appendChild(barSel);

  const cardCol=document.createElement("div");
  const cardsInput=document.createElement("input"); cardsInput.type="number"; cardsInput.min=0; cardsInput.value=h.cards_owned||0;
  cardsInput.onchange=()=>{
    h.cards_owned=Math.max(0,Math.floor(Number(cardsInput.value)||0));
    saveState();
    renderSummary();
  }
  cardCol.appendChild(cardsInput);

  const opsCol=document.createElement("div"); opsCol.className="hero-ops";
  const calcBtn=document.createElement("button"); calcBtn.className="btn ghost"; calcBtn.textContent="Tính";
  calcBtn.onclick=()=>{showModalResult(h);}
  opsCol.appendChild(calcBtn);

  box.appendChild(nameCol); box.appendChild(starCol); box.appendChild(barCol); box.appendChild(cardCol); box.appendChild(opsCol);
  return box;
}

function calculateUpgrade(hero){
  let star=hero.current_star||0, bar=hero.current_bar||0, cards=hero.cards_owned||0, cardsConsumed=0;
  const costFor=(st,barIdx)=>(COST[st]&&COST[st][barIdx]?Number(COST[st][barIdx]):null);
  while(cards>0){
    const maxBar=maxBarForStar(star);
    if(star>=5&&bar>=maxBar) break;
    let nextBar=bar+1;
    if(bar>=maxBar){if(star>=5) break; star+=1; bar=0; continue;}
    const needed=costFor(star,nextBar);
    if(needed===null){if(bar>=maxBar){if(star>=5) break; star+=1; bar=0; continue;} else break;}
    if(cards>=needed){cards-=needed; cardsConsumed+=needed; bar=nextBar; if(bar>=maxBar){if(star<5){star+=1; bar=0;} else{bar=maxBar; break;}}}else break;
  }
  const missingCards=()=>{
    let ms=0, s=star, b=bar;
    while(s<5){const maxBar=maxBarForStar(s); ms+=COST[s][b+1]||COST[s][1]; b++; if(b>maxBar){s++; b=0;}}
    return ms;
  };
  return {final_star:star,final_bar:bar,cards_left:cards,cards_consumed:cardsConsumed,missing_to_5:missingCards()};
}

function showModalResult(hero){
  let points=0,res;
  if(hero.system!=="Exp"){
    res=calculateUpgrade(hero);
    points=res.cards_consumed*14000;
  } else {
    res={cards_left:0,cards_consumed:hero.cards_owned,missing_to_5:0};
    if(expData["B+"].includes(hero.name)) points=hero.cards_owned*100;
    else if(expData["B"].includes(hero.name)) points=hero.cards_owned*700;
    else if(expData["SR"].includes(hero.name)) points=hero.cards_owned*3500;
  }
  alert(`Tướng: ${hero.name} (${hero.system})
Sao/Bậc: ${hero.current_star}★ Bậc ${hero.current_bar}
Thẻ sử dụng: ${res.cards_consumed}
Thẻ còn lại: ${res.cards_left}
Điểm: ${formatNumber(points)}
Thiếu để 5★: ${res.missing_to_5} thẻ`);
}

function renderHeroList(){
  const list=$("heroList"); list.innerHTML="";
  const filter=($("filterHero").value||"").trim().toLowerCase();
  if(SYSTEMS.includes(state.activeTab)){
    heroesData[state.activeTab].forEach(n=>{
      const h=state.heroes.find(x=>x.name===n); if(!h||(filter&&!n.toLowerCase().includes(filter))) return;
      list.appendChild(createHeroElement(h));
    });
  } else if(EXP_CATS.includes(state.activeTab)){
    expData[state.activeTab].forEach(n=>{
      const h=state.heroes.find(x=>x.name===n); if(!h||(filter&&!n.toLowerCase().includes(filter))) return;
      list.appendChild(createHeroElement(h));
    });
  }
}

function renderSummary(){
  const sumBox=$("summary"); sumBox.innerHTML="";
  const totals={};
  SYSTEMS.concat(EXP_CATS).forEach(s=>totals[s]=0);
  state.heroes.forEach(h=>{
    let points=0;
    if(h.system!=="Exp"){points=calculateUpgrade(h).cards_consumed*14000;}
    else if(expData["B+"].includes(h.name)) points=h.cards_owned*100;
    else if(expData["B"].includes(h.name)) points=h.cards_owned*700;
    else if(expData["SR"].includes(h.name)) points=h.cards_owned*3500;
    totals[h.system==="Exp"?EXP_CATS.find(cat=>expData[cat].includes(h.name)):h.system]+=points;
  });
  Object.keys(totals).forEach(s=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML=`<span>${s}</span><span class="big">${formatNumber(totals[s])}</span>`; sumBox.appendChild(row);
  });
  const totalAll=document.createElement("div"); totalAll.className="row";
  totalAll.innerHTML=`<strong>Tổng</strong><strong>${formatNumber(Object.values(totals).reduce((a,b)=>a+b,0))}</strong>`;
  sumBox.appendChild(totalAll);
}

function renderTabs(){
  const tabs=$("tabs"); tabs.innerHTML="";
  SYSTEMS.concat(EXP_CATS).forEach(tab=>{
    const btn=document.createElement("button"); btn.className="tab"+(state.activeTab===tab?" active":""); btn.textContent=tab;
    btn.onclick=()=>{state.activeTab=tab; $("systemTitle").textContent=tab; renderTabs(); renderHeroList(); renderSummary();}
    tabs.appendChild(btn);
  });
}

function init(){
  loadState(); // load dữ liệu tự lưu
  if(!state.heroes || state.heroes.length===0){
    Object.keys(heroesData).forEach(sys=>heroesData[sys].forEach(n=>state.heroes.push(defaultHeroData(n,sys))));
    Object.keys(expData).forEach(cat=>expData[cat].forEach(n=>state.heroes.push(defaultHeroData(n,"Exp"))));
  }
  renderTabs(); renderHeroList(); renderSummary();
  $("filterHero").addEventListener("input",()=>renderHeroList());
  $("btnCalcAll").onclick=()=>{
    renderSummary();
    saveState();
  };
}

init();
</script>
</body>
</html>
