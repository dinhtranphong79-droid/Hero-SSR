<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ƒêi·ªÉm t∆∞·ªõng SSR & Exp</title>
<style>
:root{
  --bg:#ffffff;
  --card:#f8f8f8;
  --muted:#555555;
  --accent:#60a5fa;
  --fire:#e11d48;
  --wind:#10b981;
  --light:#facc15;
  --dark:#6366f1;
  --earth:#a16207;
  --exp:#6b7280;
}

body {margin:0;padding:18px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#012;}
.app {max-width:1100px;margin:0 auto;}
header {display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;}
h1 {font-size:20px;margin:0;}
.controls {display:flex;gap:8px;align-items:center;}
.tabs {display:flex;gap:6px;flex-wrap:wrap;}
.tab {padding:8px 12px;border-radius:10px;cursor:pointer;background:#eaeaea;color:var(--muted);border:1px solid rgba(0,0,0,0.06)}
.tab.active {background:var(--accent);color:#fff;font-weight:600;}
.grid {display:grid;grid-template-columns:1fr 360px;gap:16px;}
.panel {background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.06);}
.hero-list {display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;}
.hero {display:grid;grid-template-columns:1fr 100px 100px 120px 80px;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.04);}
.hero small {color:var(--muted);}
input[type="number"], select, input[type="text"]{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit}
.btn {padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600;}
.btn.ghost {background:transparent;border:1px solid rgba(0,0,0,0.08);color:var(--muted);}
.summary {display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.row {display:flex;justify-content:space-between;align-items:center;}
.big {font-size:18px;font-weight:700;}
footer {margin-top:16px;color:var(--muted);font-size:13px;text-align:center;}
.hero-ops {display:flex;gap:6px;justify-content:flex-end}
@media (max-width:980px){.grid{grid-template-columns:1fr}.hero{grid-template-columns:1fr 90px 80px 80px 70px}}

/* Modal */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:9999; }
.modal-content{ background:white; width:95%; max-width:440px; border-radius:18px; padding:0; font-family:Segoe UI, sans-serif; border:4px solid var(--accent); animation: popin .25s ease;}
@keyframes popin{ from{ transform:scale(.9); opacity:0; } to{ transform:scale(1); opacity:1; } }
.modal-header{ color:white; padding:14px 18px; border-radius:14px 14px 0 0; font-size:20px; font-weight:700; }
.modal-body{ padding:18px; font-size:16px; line-height:1.5; white-space:pre-line; }
.modal-footer{ padding:16px; }
.modal-footer button{ width:100%; padding:12px; border:none; border-radius:10px; font-size:16px; cursor:pointer; color:white; }

.sys-L·ª≠a { --m-color: var(--fire); }
.sys-Cung { --m-color: var(--light); }
.sys-ƒê·ªôc { --m-color: var(--wind); }
.sys-BƒÉng { --m-color: var(--dark); }
.sys-Exp { --m-color: var(--exp); }
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>ƒêi·ªÉm t∆∞·ªõng SSR & Exp</h1>
      <div style="color:var(--muted);font-size:13px;margin-top:6px">Ch·ªâ hi·ªán k·∫øt qu·∫£ khi b·∫•m "T√≠nh". 1 th·∫ª SSR = 14.000 ƒëi·ªÉm. EXP: B+ 100 / B 700 / SR 3.500.</div>
    </div>
    <div class="controls">
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main class="grid">
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong id="systemTitle">L·ª≠a</strong></div>
        <div class="flex"><button class="btn" id="btnCalcAll">T√≠nh to√†n b·ªô</button></div>
      </div>
      <div style="margin-bottom:12px;display:flex;gap:10px">
        <input id="filterHero" placeholder="T√¨m t∆∞·ªõng theo t√™n" />
      </div>
      <div class="hero-list" id="heroList"></div>
    </section>

    <aside class="panel">
      <div><strong>T·ªïng k·∫øt</strong></div>
      <div class="summary" id="summary"></div>
    </aside>
  </main>

  <footer>SSR: sao 0..5, b·∫≠c 0..n. 5‚òÖ l√† max. D·ªØ li·ªáu t·ª± l∆∞u tr√™n tr√¨nh duy·ªát.</footer>
</div>

<!-- Modal -->
<div id="resultModal" class="modal">
  <div id="modalBox" class="modal-content sys-L·ª≠a">
    <div id="modalHeader" class="modal-header">K·∫øt qu·∫£</div>
    <div id="modalBody" class="modal-body"></div>
    <div class="modal-footer">
      <button onclick="closeModal()" id="modalCloseBtn" style="background:var(--m-color);">ƒê√≥ng</button>
    </div>
  </div>
</div>

<script>
/* --- D·ªØ li·ªáu c∆° b·∫£n --- */
const COST_ARRAY = {
  0: [20,20],
  1: [30,40,50],
  2: [60,70,80,80],
  3: [100,110,120,130,140],
  4: [170,180,190,200,210],
  5: []
};
const CARD_POINT = 14000;
const SYSTEMS = ["L·ª≠a","Cung","ƒê·ªôc","BƒÉng"];
const EXP_CATS = {"B+":100,"B":700,"SR":3500};
const heroesData = {
  "L·ª≠a":["Dolvar","Paul","Alex","Allen","Anko","Apollo","Blaise","Brie","Catrina","Christie","Cosette","Dain","Darcy","Daria","Dean","Edmund"],
  "Cung":["Aidan","Alden","Ariza","Authur","Bella","Colin","Doris","Dylan","Eleanora","Fatima","Gabriel","Green","Jennifer","Johannes","Kadir","Kailin","Layla","Livia","Maya","Meg","Mira","Montag","O'Neil","Padme","Pan","Ptolemy","Richard","Ryan","Sahar","Sebastian","Seraphia","Solder","Torvi","Trist"],
  "ƒê·ªôc":["Allison","Angelina","Arwin","Benjamin","Blackwell","Boudica","Catherine","Chiyoko","Claudia","Daisy","Elia","Gruen","Issac","Lilith","Lomax","Luvia","Maxwell","Meniere","Morgana","Mycelia","Naga","Pythia","Rila","Rogers","Rosamond","Suad","Tumnus","Viper","Viola","Webster","Wendy"],
  "BƒÉng":["Christine","Clarence","Enzo","Eslaine","Filius","Hadi","Hana","Hathes","Havik","Jessica","Judy","Keith","Lilani","Loka","Maud","Nathaniel","Nicole","Nina","Nivea","Olaf","Parr","Paula","Pedra","Ralph","Rebecca","Rudolph","Selene","Trishy","Vera","Ao Deng","Ao Yue"]
};
const expList = {
  "B+":["Daniel"],
  "B":["Anton","Peter","Etley"],
  "SR":["Alucard","Samar","Harold","Kris","Merlin","Ophelia","Arwyn"]
};
const LS_KEY = "hero_upgrader_state_v2";
const $ = id=>document.getElementById(id);
let state = { heroes: [], activeTab: SYSTEMS[0] };

/* --- Helper --- */
function idNow(){ return "h-" + Math.random().toString(36).slice(2,9); }
function formatNumber(n){ return Number(n).toLocaleString("vi-VN"); }
function maxBarForStar(st){ return (COST_ARRAY[st]||[]).length; }
function costFor(st,bar){ const arr=COST_ARRAY[st]||[]; return arr[bar]!==undefined?arr[bar]:null; }
function defaultHeroData(name, system){
  let sys = system;
  for(const cat in expList) if(expList[cat].includes(name)) { sys="Exp"; break; }
  return { id:idNow(), name, system:sys, current_star:0, current_bar:0, cards_owned:0 };
}

/* --- T√≠nh n√¢ng --- */
function calculateUpgrade(hero){
  if(hero.system==="Exp"){
    let rank=null;
    for(const cat in expList) if(expList[cat].includes(hero.name)) rank=cat;
    const per = rank?EXP_CATS[rank]:0;
    const cards=Number(hero.cards_owned)||0;
    return { isExp:true, exp_rank:rank, exp_per_card:per, exp_points:cards*per, cards_consumed:cards, cards_left:0, final_star:hero.current_star, final_bar:hero.current_bar, missing_to_5:0 };
  }
  let star=Number(hero.current_star)||0, bar=Number(hero.current_bar)||0, cards=Number(hero.cards_owned)||0, consumed=0;
  while(cards>0){
    if(star>=5) break;
    const maxBar=maxBarForStar(star);
    if(bar>=maxBar){ star+=1; bar=0; continue; }
    const needed=costFor(star,bar);
    if(needed===null) break;
    if(cards>=needed){ cards-=needed; consumed+=needed; bar+=1; } else break;
  }
  const cards_left=cards;
  let ms=0,s=star,b=bar;
  while(s<5){
    const maxBar=maxBarForStar(s);
    if(b>=maxBar){ s+=1; b=0; continue; }
    const need=costFor(s,b);
    if(need===null){ ms=Infinity; break; }
    ms+=need; b+=1;
  }
  return { isExp:false, final_star:star, final_bar:bar, cards_consumed:consumed, cards_left:cards_left, missing_to_5:ms };
}

/* --- Modal --- */
function showModal(title,message,system){
  const modal=$("resultModal"),header=$("modalHeader"),body=$("modalBody"),box=$("modalBox");
  box.className="modal-content sys-"+system;
  header.innerText=title;
  body.innerText=message;
  modal.style.display="flex";
}
function closeModal(){ $("resultModal").style.display="none"; }

/* --- Hi·ªÉn th·ªã modal k·∫øt qu·∫£ --- */
function showModalResult(hero){
  const res=calculateUpgrade(hero);
  if(res.isExp){
    const msg=`H·∫°ng EXP: ${res.exp_rank}\nS·ªë th·∫ª: ${res.cards_consumed}\nƒêi·ªÉm EXP: ${formatNumber(res.exp_points)}`;
    showModal(`T∆∞·ªõng EXP ‚Äì ${hero.name}`, msg, "Exp");
    return;
  }
  const used_cards=res.cards_consumed;
  const leftover_cards=(res.final_star>=5?res.cards_left:0);
  const used_points=used_cards*CARD_POINT;
  const leftover_points=leftover_cards*CARD_POINT;
  const total_points=used_points+leftover_points;
  const msg=`Sao/B·∫≠c hi·ªán t·∫°i: ${hero.current_star}‚òÖ b·∫≠c ${hero.current_bar}\nN√¢ng ƒë∆∞·ª£c ƒë·∫øn: ${res.final_star}‚òÖ b·∫≠c ${res.final_bar}\n\nüîπ Th·∫ª d√πng ƒë·ªÉ n√¢ng: ${used_cards}\n   ‚Üí ƒêi·ªÉm t·ª´ th·∫ª d√πng: ${formatNumber(used_points)}\n\nüîπ Th·∫ª d∆∞ sau khi ƒë·∫°t 5‚òÖ: ${leftover_cards}\n   ‚Üí ƒêi·ªÉm t·ª´ th·∫ª d∆∞: ${formatNumber(leftover_points)}\n\n‚≠ê T·ªïng ƒëi·ªÉm: ${formatNumber(total_points)}\n\nThi·∫øu ƒë·ªÉ ƒë·ªß 5‚òÖ: ${res.missing_to_5===Infinity?'Kh√¥ng x√°c ƒë·ªãnh':res.missing_to_5+' th·∫ª'}`;
  showModal(`${hero.name} ‚Äì K·∫øt qu·∫£`, msg, hero.system);
}

/* --- Render hero --- */
function createHeroElement(h){
  const box=document.createElement("div"); box.className="hero";
  const nameCol=document.createElement("div"); nameCol.innerHTML=`<div style="font-weight:600">${h.name}</div><small>${h.system}</small>`;
  const starCol=document.createElement("div");
  const starSel=document.createElement("select");
  starSel.innerHTML=Array.from({length:6}).map((_,i)=>`<option value="${i}" ${i===h.current_star?"selected":""}>${i}‚òÖ</option>`).join("");
  starSel.onchange=()=>{ h.current_star=parseInt(starSel.value,10); if(h.current_bar>maxBarForStar(h.current_star)) h.current_bar=maxBarForStar(h.current_star); saveState(); renderHeroList(); renderSummary(); };
  starCol.appendChild(starSel);
  const barCol=document.createElement("div");
  const barSel=document.createElement("select");
  barSel.innerHTML=Array.from({length:maxBarForStar(h.current_star)+1}).map((_,i)=>`<option value="${i}" ${i===h.current_bar?"selected":""}>B·∫≠c ${i}</option>`).join("");
  barSel.onchange=()=>{ h.current_bar=parseInt(barSel.value,10); saveState(); renderHeroList(); renderSummary(); };
  barCol.appendChild(barSel);
  const cardCol=document.createElement("div");
  const cardsInput=document.createElement("input"); cardsInput.type="number"; cardsInput.min=0; cardsInput.value=h.cards_owned||0;
  cardsInput.onchange=()=>{ h.cards_owned=Math.max(0,Math.floor(Number(cardsInput.value)||0)); saveState(); };
  cardCol.appendChild(cardsInput);
  const opsCol=document.createElement("div"); opsCol.className="hero-ops";
  const calcBtn=document.createElement("button"); calcBtn.className="btn ghost"; calcBtn.textContent="T√≠nh";
  calcBtn.onclick=()=>showModalResult(h);
  opsCol.appendChild(calcBtn);
  box.appendChild(nameCol); box.appendChild(starCol); box.appendChild(barCol); box.appendChild(cardCol); box.appendChild(opsCol);
  return box;
}
function renderHeroList(){
  const list=$("heroList"); list.innerHTML="";
  const f=($("filterHero").value||"").trim().toLowerCase();
  if(SYSTEMS.includes(state.activeTab)){
    (heroesData[state.activeTab]||[]).forEach(n=>{
      if(f && !n.toLowerCase().includes(f)) return;
      const h=state.heroes.find(x=>x.name===n);
      if(h) list.appendChild(createHeroElement(h));
    });
  } else {
    for(const cat in expList){
      if(cat!==state.activeTab) continue;
      expList[cat].forEach(n=>{
        if(f && !n.toLowerCase().includes(f)) return;
        const h=state.heroes.find(x=>x.name===n);
        if(h) list.appendChild(createHeroElement(h));
      });
    }
  }
}
function renderSummary(){
  const box=$("summary"); box.innerHTML="";
  const totals={}; SYSTEMS.concat(Object.keys(expList)).forEach(s=>totals[s]=0);
  state.heroes.forEach(h=>{
    let pts=0;
    if(h.system==="Exp"){
      for(const cat in expList) if(expList[cat].includes(h.name)){ pts=(Number(h.cards_owned)||0)*EXP_CATS[cat]; totals[cat]+=pts; break; }
    } else {
      const r=calculateUpgrade(h); let pCount=r.cards_consumed; if(r.final_star>=5) pCount+=r.cards_left; pts=pCount*CARD_POINT; totals[h.system]+=pts;
    }
  });
  for(const k in totals){ const row=document.createElement("div"); row.className="row"; row.innerHTML=`<div style="font-weight:600">${k}</div><div class="big">${formatNumber(totals[k])}</div>`; box.appendChild(row);}
  const totalAll=Object.values(totals).reduce((a,b)=>a+b,0);
  const tr=document.createElement("div"); tr.className="row"; tr.style.marginTop="8px"; tr.innerHTML=`<strong>T·ªïng</strong><strong>${formatNumber(totalAll)}</strong>`; box.appendChild(tr);
}
function renderTabs(){
  const tabs=$("tabs"); tabs.innerHTML="";
  SYSTEMS.concat(Object.keys(expList)).forEach(t=>{
    const b=document.createElement("button"); b.className="tab"+(state.activeTab===t?" active":""); b.textContent=t;
    b.onclick=()=>{ state.activeTab=t; $("systemTitle").textContent=t; renderTabs(); renderHeroList(); renderSummary(); };
    tabs.appendChild(b);
  });
}
function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(raw){ const parsed=JSON.parse(raw); if(parsed&&parsed.heroes) state.heroes=parsed.heroes; if(parsed&&parsed.activeTab) state.activeTab=parsed.activeTab; }
    else{ Object.keys(heroesData).forEach(sys=>{ heroesData[sys].forEach(n=>state.heroes.push(defaultHeroData(n,sys))); }); Object.keys(expList).forEach(cat=>{ expList[cat].forEach(n=>state.heroes.push(defaultHeroData(n,"Exp"))); }); }
  }catch(e){ console.error("Load state failed", e); state={ heroes: [], activeTab: SYSTEMS[0] }; }
}
function saveState(){ try{ localStorage.setItem(LS_KEY,JSON.stringify({heroes:state.heroes,activeTab:state.activeTab})); }catch(e){console.error("Save failed",e);} }
function init(){
  loadState(); renderTabs(); renderHeroList(); renderSummary();
  $("filterHero").addEventListener("input",()=>renderHeroList());
  $("btnCalcAll").onclick=()=>{ renderSummary(); showModal("T·ªïng k·∫øt","Xem t·ªïng theo t·ª´ng h·ªá v√† t·ªïng c·ªông.",state.activeTab); saveState(); };
}
init();
</script>
</body>
</html>
